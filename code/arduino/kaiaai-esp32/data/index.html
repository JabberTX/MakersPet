<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8"/>
  <link rel="icon" href="/favicon.png">
<style>
* {
  box-sizing: border-box;
}

html {
  font-family: Arial, Helvetica, sans-serif; 
}

.topnav { 
  overflow: hidden; 
  background-color: #45a049;
}

h1 {
  font-size: 1.8rem; 
  color: white;
  padding: 2px 20px;
}

input[type=text], input[type=number], input[type=password], select, textarea {
  width: 100%;
  padding: 12px;
  border: 1px solid #ccc;
  border-radius: 4px;
  resize: vertical;
}

.sub_input {
  width:50%;
}

label {
  padding: 12px 12px 12px 0;
  display: inline-block;
}

.clickable {
  cursor:pointer;
  color:blue;
}

.clickable:hover {
  cursor:hand;  
  color:#0096FF;
  text-decoration:underline;
}

input[type=submit], input[type=reset], button {
  color: #FEFCFB;
  background-color: #45a049;
  text-align: center;
  font-size: 16px;
  margin: 0px 10px 10px 0px;
  padding: 12px 20px;
  border: none;
  border-radius: 4px;
  cursor: pointer;
}

input[type=submit]:hover, button:hover {
  background-color: #034078;
}

button:disabled, button[disabled] {
  border: 1px solid #999999;
  background-color: #cccccc;
  color: #666666;
}
.container {
  border-radius: 5px;
  background-color: #f2f2f2;
  padding: 20px;
}

.col-25 {
  float: left;
  width: 25%;
  margin-top: 6px;
}

.col-75 {
  float: left;
  width: 75%;
  margin-top: 6px;
}

.col-100 {
  float: left;
  width: 100%;
  margin-top: 6px;
}

/* Clear floats after the columns */
.row::after {
  content: "";
  display: table;
  clear: both;
}

/* Responsive layout - when the screen is less than 600px wide, make the two columns stack on top of each other instead of next to each other */
@media screen and (max-width: 600px) {
  .col-25, .col-75, input[type=submit] {
    width: 100%;
    margin-top: 0;
  }
}
</style>
  <title>Robot Connection Configurator</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
<script>
let networkCount = 0;

function addNetwork(ssid = '', pass = '', dest_ip = '') {
  const networksDiv = document.getElementById('networks');
  const networkId = networkCount++;

  const networkHTML = `
    <div id="network-${networkId}" class="network-group">
      <hr>
      <div class="row">
        <div class="col-25">
          <label for="ssid-${networkId}">WiFi Access Point SSID 2.4GHz</label>
        </div>
        <div class="col-75">
          <input type="text" id="ssid-${networkId}" name="ssid-${networkId}" minlength="1" maxlength="32" placeholder="My_Wifi_Router" required value="${ssid}">
        </div>
      </div>
      <div class="row">
        <div class="col-25">
          <label for="pass-${networkId}">WiFi Password</label>
        </div>
        <div class="col-75">
          <div class="sub_input">
            <input type="password" id="pass-${networkId}" name="pass-${networkId}" value="${pass}">
          </div>
        </div>
        </div>
      <input type="hidden" id="dest_ip-${networkId}" name="dest_ip-${networkId}" value="1.2.3.4">
      <div class="row">
        <div class="col-75">
            <button type="button" onclick="removeNetwork(${networkId})">Remove</button>
        </div>
      </div>
    </div>
  `;

  networksDiv.insertAdjacentHTML('beforeend', networkHTML);
}

function removeNetwork(id) {
  const networkDiv = document.getElementById(`network-${id}`);
  networkDiv.remove();
}

function loadNetworks() {
  const NETWORK_YAML = "/network.yaml";
  fetch(NETWORK_YAML)
    .then(function(response) {
      if (response.ok) {
        return response.text();
      } else {
        addNetwork();
        return null;
      }
    })
    .then(function(text) {
      if (text) {
        const lines = text.trim().split('\n');
        let network = {};
        for (const line of lines) {
          if (line.startsWith('  ssid:')) {
            if (Object.keys(network).length > 0) {
              addNetwork(network.ssid, network.pass, network.dest_ip);
            }
            network = {};
            network.ssid = line.substring(line.indexOf(':') + 2).replace(/"/g, '');
          } else if (line.startsWith('  pass:')) {
            network.pass = line.substring(line.indexOf(':') + 2).replace(/"/g, '');
          } else if (line.trim().startsWith('mdns_service_name:')) {
            const value = line.substring(line.indexOf(':') + 2).replace(/"/g, '');
            document.getElementById('mdns_service_name').value = value;
          }
        }
        if (Object.keys(network).length > 0) {
          addNetwork(network.ssid, network.pass, network.dest_ip);
        }
      }
    })
    .catch((error) => {
      console.log('Exception fetching ' + NETWORK_YAML);
      addNetwork();
    });
}

document.addEventListener('DOMContentLoaded', function() {
  loadNetworks();
  document.getElementById('add-network').addEventListener('click', function() {
    addNetwork();
  });
});
</script>
</head>
<body>
  <div class="topnav">
    <h1>Robot Connection Configurator</h1>
  </div>
  <div class="container">
    <form action="/" method="POST">
      <fieldset>
        <legend>Network</legend>
        <div id="networks"></div>
        <button type="button" id="add-network">Add Network</button>
      </fieldset>
      <br>
      <fieldset>
        <legend>Micro-ROS</legend>
        <div class="row">
            <div class="col-25">
              <label for="mdns_service_name">Unique Bot Name</label>
            </div>
            <div class="col-75">
              <input type="text" id="mdns_service_name" name="mdns_service_name" placeholder="my-robot">
            </div>
            <div class="col-100">
              <div class="">Note: Update bot name in avahi-daemon to match, at /etc/avahi/services/ros2-agent.service</div>
              <div class="">Restart daemon with sudo systemctl restart avahi-daemon</div>
            </div>
        </div>
      </fieldset>
      <br>
      <div class="row">
        <div class="col-25">
          <input type="reset" id="reset" value="Clear">
        </div>
        <div class="col-75">
          <input type="submit" value="Connect">
        </div>
      </div>
    </form>
  </div>
</body>
</html>